generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Post {
  id          Int      @id @default(autoincrement())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])

  @@index([name])
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                    String                  @id @default(cuid())
  name                  String?
  email                 String?                 @unique @db.VarChar(255)
  emailVerified         DateTime?
  image                 String?
  role                  UserRole                @default(CUSTOMER)
  phoneNumber           String?                 @db.VarChar(20)
  isActive              Boolean                 @default(true)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  password              String?
  districtCode          String?                 @db.VarChar(10)
  districtName          String?                 @db.VarChar(100)
  provinceCode          String?                 @db.VarChar(10)
  provinceName          String?                 @db.VarChar(100)
  regencyCode           String?                 @db.VarChar(10)
  regencyName           String?                 @db.VarChar(100)
  streetAddress         String?                 @db.VarChar(500)
  accounts              Account[]
  adminKosProfile       AdminKosProfile?
  customerProfile       CustomerProfile?
  posts                 Post[]
  approvedProperties    Property[]              @relation("PropertyApprover")
  ownedProperties       Property[]              @relation("PropertyOwner")
  PropertyStatusHistory PropertyStatusHistory[]
  receptionistProfile   ReceptionistProfile?
  sessions              Session[]
  bookings              Booking[]
  payments              Payment[]

  @@index([email])
  @@index([role])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model AdminKosProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ReceptionistProfile {
  id        String    @id @default(cuid())
  userId    String    @unique
  startDate DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  shift     Shift?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CustomerProfile {
  id               String    @id @default(cuid())
  userId           String    @unique
  dateOfBirth      DateTime?
  gender           String?
  emergencyContact String?
  emergencyPhone   String?
  status           CustomerStatus?
  institutionName  String?   @db.VarChar(255)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Property {
  id                    String                  @id @default(cuid())
  name                  String                  @db.VarChar(255)
  buildYear             Int
  propertyType          PropertyType
  description           String
  roomTypes             Json
  totalRooms            Int
  availableRooms        Int                     @default(0)
  provinceCode          String                  @db.VarChar(10)
  provinceName          String                  @db.VarChar(100)
  regencyCode           String                  @db.VarChar(10)
  regencyName           String                  @db.VarChar(100)
  districtCode          String                  @db.VarChar(10)
  districtName          String                  @db.VarChar(100)
  fullAddress           String                  @db.VarChar(500)
  latitude              Float
  longitude             Float
  facilities            Json
  rules                 Json
  status                PropertyStatus          @default(PENDING)
  ownerId               String
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  approvedAt            DateTime?
  approvedBy            String?
  approver              User?                   @relation("PropertyApprover", fields: [approvedBy], references: [id])
  owner                 User                    @relation("PropertyOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  images                PropertyImage[]
  PropertyStatusHistory PropertyStatusHistory[]
  rooms                 Room[]
  bookings              Booking[]

  @@index([status])
  @@index([propertyType])
  @@index([ownerId])
  @@index([provinceCode, regencyCode, districtCode])
}

model PropertyImage {
  id         String        @id @default(cuid())
  propertyId String
  category   ImageCategory
  imageUrl   String        @db.VarChar(500)
  publicId   String?       @db.VarChar(255)
  caption    String?       @db.VarChar(255)
  sortOrder  Int           @default(0)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  property   Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId, category])
}

model Room {
  id                String             @id @default(cuid())
  propertyId        String
  roomNumber        String             @db.VarChar(50)
  floor             Int
  roomType          String             @db.VarChar(100)
  description       String?
  size              String?            @db.VarChar(50)
  monthlyPrice      Decimal            @db.Decimal(10, 2)
  dailyPrice        Decimal?           @db.Decimal(10, 2)
  weeklyPrice       Decimal?           @db.Decimal(10, 2)
  quarterlyPrice    Decimal?           @db.Decimal(10, 2)
  yearlyPrice       Decimal?           @db.Decimal(10, 2)
  hasDeposit        Boolean            @default(false)
  // New deposit fields
  depositRequired   Boolean            @default(false)
  depositType       DepositType?       @default(PERCENTAGE)
  depositValue      Decimal?           @db.Decimal(10, 2)
  // Legacy field for backward compatibility
  depositPercentage DepositPercentage?
  facilities        Json
  isAvailable       Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  property          Property           @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  images            RoomImage[]
  bookings          Booking[]

  @@unique([propertyId, roomNumber])
  @@index([propertyId])
  @@index([roomType])
  @@index([isAvailable])
}

model RoomImage {
  id        String        @id @default(cuid())
  roomId    String
  category  ImageCategory
  imageUrl  String        @db.VarChar(500)
  publicId  String?       @db.VarChar(255)
  caption   String?       @db.VarChar(255)
  sortOrder Int           @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  room      Room          @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId, category])
}

model PropertyStatusHistory {
  id         String          @id
  propertyId String
  fromStatus PropertyStatus?
  toStatus   PropertyStatus
  reason     String?
  changedBy  String
  createdAt  DateTime        @default(now())
  User       User            @relation(fields: [changedBy], references: [id])
  Property   Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([changedBy])
  @@index([createdAt])
  @@index([propertyId])
  @@index([toStatus])
}

model Booking {
  id             String        @id @default(cuid())
  bookingCode    String        @unique @db.VarChar(20)
  userId         String
  propertyId     String
  roomId         String
  checkInDate    DateTime
  checkOutDate   DateTime?
  leaseType      LeaseType
  totalAmount    Decimal       @db.Decimal(12, 2)
  depositAmount  Decimal?      @db.Decimal(12, 2)
  paymentStatus  PaymentStatus @default(PENDING)
  status         BookingStatus @default(PENDING)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  user           User          @relation(fields: [userId], references: [id])
  property       Property      @relation(fields: [propertyId], references: [id])
  room           Room          @relation(fields: [roomId], references: [id])
  payments       Payment[]

  @@index([userId])
  @@index([propertyId])
  @@index([roomId])
  @@index([status])
  @@index([paymentStatus])
  @@index([checkInDate])
}

model Payment {
  id               String        @id @default(cuid())
  bookingId        String
  userId           String
  midtransOrderId  String        @unique @db.VarChar(100)
  paymentType      PaymentType
  paymentMethod    String?       @db.VarChar(50)
  amount           Decimal       @db.Decimal(12, 2)
  status           PaymentStatus @default(PENDING)
  transactionTime  DateTime?
  transactionId    String?       @db.VarChar(100)
  paymentToken     String?       @db.VarChar(500)
  expiryTime       DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  booking          Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user             User          @relation(fields: [userId], references: [id])

  @@index([bookingId])
  @@index([userId])
  @@index([status])
  @@index([midtransOrderId])
}

enum UserRole {
  SUPERADMIN
  ADMINKOS
  RECEPTIONIST
  CUSTOMER
}

enum Shift {
  MORNING
  EVENING
  NIGHT
}

enum PropertyType {
  MALE_ONLY
  FEMALE_ONLY
  MIXED
}

enum PropertyStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum ImageCategory {
  BUILDING_PHOTOS
  SHARED_FACILITIES_PHOTOS
  FLOOR_PLAN_PHOTOS
  ROOM_PHOTOS
  BATHROOM_PHOTOS
}

enum DepositPercentage {
  TEN_PERCENT
  TWENTY_PERCENT
  THIRTY_PERCENT
  FORTY_PERCENT
  FIFTY_PERCENT
}

enum BookingStatus {
  PENDING
  DEPOSIT_PAID
  CONFIRMED
  CHECKED_IN
  COMPLETED
  CANCELLED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  EXPIRED
  REFUNDED
}

enum PaymentType {
  DEPOSIT
  FULL
}

enum LeaseType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum DepositType {
  PERCENTAGE
  FIXED
}

enum CustomerStatus {
  MAHASISWA
  PEKERJA
}

// Website Analytics Models
model WebsiteVisitor {
  id            String    @id @default(cuid())
  sessionId     String    @unique @db.VarChar(255)
  ipAddress     String    @db.VarChar(45) // IPv6 support
  userAgent     String?   @db.Text
  country       String?   @db.VarChar(100)
  city          String?   @db.VarChar(100)
  device        String?   @db.VarChar(50)  // mobile, desktop, tablet
  browser       String?   @db.VarChar(50)
  os            String?   @db.VarChar(50)
  referrer      String?   @db.Text
  landingPage   String    @db.VarChar(500)
  isReturning   Boolean   @default(false)
  visitDuration Int?      // in seconds
  pageViewCount Int       @default(1)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastSeenAt    DateTime  @default(now())

  // Relations
  pageViews     PageView[]

  @@index([sessionId])
  @@index([ipAddress])
  @@index([createdAt])
  @@index([isReturning])
}

model PageView {
  id          String         @id @default(cuid())
  visitorId   String
  sessionId   String         @db.VarChar(255)
  page        String         @db.VarChar(500)
  title       String?        @db.VarChar(255)
  timeSpent   Int?           // in seconds
  createdAt   DateTime       @default(now())

  // Relations
  visitor     WebsiteVisitor @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@index([visitorId])
  @@index([sessionId])
  @@index([page])
  @@index([createdAt])
}
