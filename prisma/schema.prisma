generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Post {
  id          Int      @id @default(autoincrement())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])

  @@index([name])
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                      String                  @id @default(cuid())
  name                    String?
  email                   String?                 @unique @db.VarChar(255)
  emailVerified           DateTime?
  image                   String?
  role                    UserRole                @default(CUSTOMER)
  phoneNumber             String?                 @db.VarChar(20)
  isActive                Boolean                 @default(true)
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  password                String?
  districtCode            String?                 @db.VarChar(10)
  districtName            String?                 @db.VarChar(100)
  provinceCode            String?                 @db.VarChar(10)
  provinceName            String?                 @db.VarChar(100)
  regencyCode             String?                 @db.VarChar(10)
  regencyName             String?                 @db.VarChar(100)
  streetAddress           String?                 @db.VarChar(500)
  accounts                Account[]
  adminKosProfile         AdminKosProfile?
  customerProfile         CustomerProfile?
  posts                   Post[]
  approvedProperties      Property[]              @relation("PropertyApprover")
  ownedProperties         Property[]              @relation("PropertyOwner")
  PropertyStatusHistory   PropertyStatusHistory[]
  receptionistProfile     ReceptionistProfile?
  sessions                Session[]
  bookings                Booking[]
  payments                Payment[]
  createdShiftAssignments ShiftAssignment[]       @relation("ShiftCreator")
  approvedBankAccounts    BankAccount[]
  processedPayouts        Payout[]
  handledCheckIns         Booking[]               @relation("BookingCheckedInBy")
  handledCheckOuts        Booking[]               @relation("BookingCheckedOutBy")
  submittedAdvertisements Advertisement[]         @relation("AdvertisementSubmitter")
  reviewedAdvertisements  Advertisement[]         @relation("AdvertisementReviewer")
  siteContentsUpdated     SiteContent[]

  @@index([email])
  @@index([role])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model AdminKosProfile {
  id             String          @id @default(cuid())
  userId         String          @unique
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankAccounts   BankAccount[]
  payouts        Payout[]
  ledgerAccounts LedgerAccount[]
  ledgerEntries  LedgerEntry[]
}

model ReceptionistProfile {
  id               String            @id @default(cuid())
  userId           String            @unique
  propertyId       String?
  startDate        DateTime?
  defaultShift     Shift?
  gender           String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  property         Property?         @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  shiftAssignments ShiftAssignment[]

  @@index([propertyId])
  @@index([userId])
}

model ShiftAssignment {
  id             String              @id @default(cuid())
  receptionistId String
  propertyId     String
  shiftType      Shift
  date           DateTime            @db.Date
  startTime      String              @db.VarChar(5) // HH:mm format
  endTime        String              @db.VarChar(5) // HH:mm format
  notes          String?             @db.Text
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  createdBy      String
  receptionist   ReceptionistProfile @relation(fields: [receptionistId], references: [id], onDelete: Cascade)
  property       Property            @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  creator        User                @relation("ShiftCreator", fields: [createdBy], references: [id])

  @@unique([receptionistId, date, shiftType])
  @@index([receptionistId])
  @@index([propertyId])
  @@index([date])
  @@index([shiftType])
}

model CustomerProfile {
  id               String          @id @default(cuid())
  userId           String          @unique
  dateOfBirth      DateTime?
  gender           String?
  emergencyContact String?
  emergencyPhone   String?
  status           CustomerStatus?
  institutionName  String?         @db.VarChar(255)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Property {
  id                    String                  @id @default(cuid())
  name                  String                  @db.VarChar(255)
  buildYear             Int
  propertyType          PropertyType
  description           String
  roomTypes             Json
  totalRooms            Int
  availableRooms        Int                     @default(0)
  provinceCode          String                  @db.VarChar(10)
  provinceName          String                  @db.VarChar(100)
  regencyCode           String                  @db.VarChar(10)
  regencyName           String                  @db.VarChar(100)
  districtCode          String                  @db.VarChar(10)
  districtName          String                  @db.VarChar(100)
  fullAddress           String                  @db.VarChar(500)
  latitude              Float
  longitude             Float
  facilities            Json
  rules                 Json
  status                PropertyStatus          @default(PENDING)
  ownerId               String
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  approvedAt            DateTime?
  approvedBy            String?
  approver              User?                   @relation("PropertyApprover", fields: [approvedBy], references: [id])
  owner                 User                    @relation("PropertyOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  images                PropertyImage[]
  PropertyStatusHistory PropertyStatusHistory[]
  rooms                 Room[]
  roomTypeImages        RoomTypeImage[]
  bookings              Booking[]
  receptionists         ReceptionistProfile[]
  shiftAssignments      ShiftAssignment[]

  @@index([status])
  @@index([propertyType])
  @@index([ownerId])
  @@index([provinceCode, regencyCode, districtCode])
}

model PropertyImage {
  id         String        @id @default(cuid())
  propertyId String
  category   ImageCategory
  imageUrl   String        @db.VarChar(500)
  publicId   String?       @db.VarChar(255)
  caption    String?       @db.VarChar(255)
  sortOrder  Int           @default(0)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  property   Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId, category])
}

model Room {
  id                String             @id @default(cuid())
  propertyId        String
  roomNumber        String             @db.VarChar(50)
  floor             Int
  roomType          String             @db.VarChar(100)
  description       String?
  size              String?            @db.VarChar(50)
  monthlyPrice      Decimal            @db.Decimal(10, 2)
  dailyPrice        Decimal?           @db.Decimal(10, 2)
  weeklyPrice       Decimal?           @db.Decimal(10, 2)
  quarterlyPrice    Decimal?           @db.Decimal(10, 2)
  yearlyPrice       Decimal?           @db.Decimal(10, 2)
  hasDeposit        Boolean            @default(false)
  // New deposit fields
  depositRequired   Boolean            @default(false)
  depositType       DepositType?       @default(PERCENTAGE)
  depositValue      Decimal?           @db.Decimal(10, 2)
  // Legacy field for backward compatibility
  depositPercentage DepositPercentage?
  facilities        Json
  isAvailable       Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  property          Property           @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  bookings          Booking[]

  @@unique([propertyId, roomNumber])
  @@index([propertyId])
  @@index([roomType])
  @@index([isAvailable])
}

// Shared images for room types (to avoid duplication)
// All rooms with same type in same property share these images
model RoomTypeImage {
  id         String        @id @default(cuid())
  propertyId String
  roomType   String        @db.VarChar(100)
  category   ImageCategory
  imageUrl   String        @db.VarChar(500)
  publicId   String?       @db.VarChar(255)
  caption    String?       @db.VarChar(255)
  sortOrder  Int           @default(0)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  property   Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId, roomType])
  @@index([propertyId, roomType, category])
}

model PropertyStatusHistory {
  id         String          @id
  propertyId String
  fromStatus PropertyStatus?
  toStatus   PropertyStatus
  reason     String?
  changedBy  String
  createdAt  DateTime        @default(now())
  User       User            @relation(fields: [changedBy], references: [id])
  Property   Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([changedBy])
  @@index([createdAt])
  @@index([propertyId])
  @@index([toStatus])
}

model Booking {
  id               String        @id @default(cuid())
  bookingCode      String        @unique @db.VarChar(20)
  userId           String
  propertyId       String
  roomId           String
  checkInDate      DateTime
  checkOutDate     DateTime?
  leaseType        LeaseType
  totalAmount      Decimal       @db.Decimal(12, 2)
  depositAmount    Decimal?      @db.Decimal(12, 2)
  discountAmount   Decimal?      @db.Decimal(12, 2) // Potongan harga yang diberikan
  discountNote     String?       @db.VarChar(255)   // Catatan untuk potongan harga
  finalAmount      Decimal?      @db.Decimal(12, 2) // Harga setelah diskon (totalAmount - discountAmount)
  paymentStatus    PaymentStatus @default(PENDING)
  status           BookingStatus @default(UNPAID)
  checkedInBy      String?
  actualCheckInAt  DateTime?
  checkedOutBy     String?
  actualCheckOutAt DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  user             User      @relation(fields: [userId], references: [id])
  property         Property  @relation(fields: [propertyId], references: [id])
  room             Room      @relation(fields: [roomId], references: [id])
  checkedInByUser  User?     @relation("BookingCheckedInBy", fields: [checkedInBy], references: [id], onDelete: SetNull)
  checkedOutByUser User?     @relation("BookingCheckedOutBy", fields: [checkedOutBy], references: [id], onDelete: SetNull)
  payments         Payment[]

  @@index([userId])
  @@index([propertyId])
  @@index([roomId])
  @@index([status])
  @@index([paymentStatus])
  @@index([checkInDate])
  @@index([actualCheckInAt])
  @@index([actualCheckOutAt])
  @@index([checkedInBy])
  @@index([checkedOutBy])
  @@index([createdAt])
}

model Payment {
  id              String        @id @default(cuid())
  bookingId       String
  userId          String
  midtransOrderId String        @unique @db.VarChar(100)
  paymentType     PaymentType
  paymentMethod   String?       @db.VarChar(50)
  amount          Decimal       @db.Decimal(12, 2)
  status          PaymentStatus @default(PENDING)
  transactionTime DateTime?
  transactionId   String?       @db.VarChar(100)
  paymentToken    String?       @db.VarChar(500)
  expiryTime      DateTime?
  accountId       String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@index([bookingId])
  @@index([userId])
  @@index([status])
  @@index([midtransOrderId])
  @@index([status, expiryTime])
  @@index([expiryTime])
}

enum UserRole {
  SUPERADMIN
  ADMINKOS
  RECEPTIONIST
  CUSTOMER
}

enum Shift {
  MORNING
  EVENING
  NIGHT
}

enum PropertyType {
  MALE_ONLY
  FEMALE_ONLY
  MIXED
}

enum PropertyStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum ImageCategory {
  BUILDING_PHOTOS
  SHARED_FACILITIES_PHOTOS
  FLOOR_PLAN_PHOTOS
  ROOM_PHOTOS
  BATHROOM_PHOTOS
}

enum DepositPercentage {
  TEN_PERCENT
  TWENTY_PERCENT
  THIRTY_PERCENT
  FORTY_PERCENT
  FIFTY_PERCENT
}

enum BookingStatus {
  UNPAID // Booking created but payment not completed yet
  DEPOSIT_PAID // Deposit payment successful
  CONFIRMED // Full payment successful
  CHECKED_IN // Customer has checked in
  COMPLETED // Booking completed (checked out)
  CANCELLED // Booking cancelled by user or admin
  EXPIRED // Payment expired, booking invalid
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  EXPIRED
  REFUNDED
}

enum PaymentType {
  DEPOSIT
  FULL
}

enum LeaseType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum DepositType {
  PERCENTAGE
  FIXED
}

enum CustomerStatus {
  MAHASISWA
  PEKERJA
}

// Website Analytics Models
model WebsiteVisitor {
  id            String   @id @default(cuid())
  sessionId     String   @unique @db.VarChar(255)
  ipAddress     String   @db.VarChar(45) // IPv6 support
  userAgent     String?  @db.Text
  country       String?  @db.VarChar(100)
  city          String?  @db.VarChar(100)
  device        String?  @db.VarChar(50) // mobile, desktop, tablet
  browser       String?  @db.VarChar(50)
  os            String?  @db.VarChar(50)
  referrer      String?  @db.Text
  landingPage   String   @db.VarChar(500)
  isReturning   Boolean  @default(false)
  visitDuration Int? // in seconds
  pageViewCount Int      @default(1)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastSeenAt    DateTime @default(now())

  // Relations
  pageViews PageView[]

  @@index([sessionId])
  @@index([ipAddress])
  @@index([createdAt])
  @@index([isReturning])
}

model PageView {
  id        String   @id @default(cuid())
  visitorId String
  sessionId String   @db.VarChar(255)
  page      String   @db.VarChar(500)
  title     String?  @db.VarChar(255)
  timeSpent Int? // in seconds
  createdAt DateTime @default(now())

  // Relations
  visitor WebsiteVisitor @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@index([visitorId])
  @@index([sessionId])
  @@index([page])
  @@index([createdAt])
}

// Bank Account for AdminKos
model BankAccount {
  id              String            @id @default(cuid())
  adminKosId      String
  bankCode        String            @db.VarChar(10) // Code from Kemenkeu API
  bankName        String            @db.VarChar(255)
  accountNumber   String            @db.VarChar(50)
  accountName     String            @db.VarChar(255)
  status          BankAccountStatus @default(PENDING)
  rejectionReason String?
  approvedBy      String?
  approvedAt      DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  adminKos        AdminKosProfile   @relation(fields: [adminKosId], references: [id], onDelete: Cascade)
  approver        User?             @relation(fields: [approvedBy], references: [id])
  payouts         Payout[]

  @@index([adminKosId])
  @@index([status])
}

// Payout (Withdraw) Request
model Payout {
  id              String             @id @default(cuid())
  adminKosId      String
  bankAccountId   String
  amount          Decimal            @db.Decimal(12, 2)
  source          PayoutSource       @default(SALES)
  balanceBefore   Decimal            @db.Decimal(12, 2)
  balanceAfter    Decimal            @db.Decimal(12, 2)
  status          PayoutStatus       @default(PENDING)
  notes           String?
  rejectionReason String?
  processedBy     String?
  processedAt     DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  adminKos        AdminKosProfile    @relation(fields: [adminKosId], references: [id], onDelete: Cascade)
  bankAccount     BankAccount        @relation(fields: [bankAccountId], references: [id])
  processor       User?              @relation(fields: [processedBy], references: [id])
  attachments     PayoutAttachment[]

  @@index([adminKosId])
  @@index([status])
  @@index([createdAt])
}

// Payout Attachment (Bukti Transfer)
model PayoutAttachment {
  id        String   @id @default(cuid())
  payoutId  String
  fileUrl   String   @db.VarChar(500)
  fileName  String   @db.VarChar(255)
  fileType  String   @db.VarChar(50) // image/jpeg, application/pdf, etc
  publicId  String?  @db.VarChar(255) // Cloudinary public ID
  createdAt DateTime @default(now())
  payout    Payout   @relation(fields: [payoutId], references: [id], onDelete: Cascade)

  @@index([payoutId])
}

// Enums
enum BankAccountStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PayoutStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum PayoutSource {
  SALES
  DEPOSIT
  OTHER
}

// Ledger System Enums
enum LedgerAccountType {
  INCOME // pemasukan
  EXPENSE // pengeluaran
  OTHER
}

enum LedgerRefType {
  PAYMENT // otomatis dari Payment SUCCESS
  PAYOUT // otomatis dari Payout APPROVED/COMPLETED
  MANUAL // input manual admin
  ADJUSTMENT // penyesuaian saldo
}

// Akun/kategori pembukuan per AdminKos
model LedgerAccount {
  id         String            @id @default(cuid())
  adminKosId String
  code       String?           @db.VarChar(30) // opsional, unik per admin
  name       String            @db.VarChar(100)
  type       LedgerAccountType
  isSystem   Boolean           @default(false) // true untuk "Pembayaran Kos"
  isArchived Boolean           @default(false)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  adminKos AdminKosProfile @relation(fields: [adminKosId], references: [id], onDelete: Cascade)
  entries  LedgerEntry[]

  @@unique([adminKosId, name])
  @@index([adminKosId, type])
}

// Buku kas (single-entry) agar simpel & cepat
model LedgerEntry {
  id         String   @id @default(cuid())
  adminKosId String
  accountId  String
  // direction: IN = debit kas (masuk), OUT = kredit kas (keluar)
  direction  String   @db.VarChar(3) // "IN" | "OUT"
  amount     Decimal  @db.Decimal(14, 2)
  date       DateTime @default(now())
  note       String?  @db.VarChar(500)

  // Jejak referensi
  refType    LedgerRefType
  refId      String?       @db.VarChar(100) // Payment.id / Payout.id / manual id
  propertyId String? // opsional tagging per properti

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  adminKos AdminKosProfile @relation(fields: [adminKosId], references: [id], onDelete: Cascade)
  account  LedgerAccount   @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([adminKosId, direction])
  @@index([adminKosId, date])
  @@index([refType, refId])
}

// Advertisement/Iklan Model with Approval Flow
model Advertisement {
  id               String              @id @default(cuid())
  title            String              @db.VarChar(255)
  description      String?             @db.Text
  imageUrl         String              @db.VarChar(500)
  publicId         String?             @db.VarChar(255) // Cloudinary public ID
  linkUrl          String?             @db.VarChar(500) // Optional link when ad is clicked
  
  // Approval workflow
  status           AdvertisementStatus @default(PENDING)
  submittedBy      String              // AdminKos user ID
  submittedAt      DateTime            @default(now())
  reviewedBy       String?             // SuperAdmin user ID
  reviewedAt       DateTime?
  rejectionReason  String?             @db.Text
  
  // Layout placement
  layoutSlot       Int?                // Which carousel slot (1-based index)
  placedAt         DateTime?           // When it was placed in layout
  
  // Display settings
  sortOrder        Int                 @default(0)
  isActive         Boolean             @default(true)
  startDate        DateTime?           // Optional: when ad should start showing
  endDate          DateTime?           // Optional: when ad should stop showing
  
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  submitter User @relation("AdvertisementSubmitter", fields: [submittedBy], references: [id], onDelete: Cascade)
  reviewer  User? @relation("AdvertisementReviewer", fields: [reviewedBy], references: [id])

  @@index([status])
  @@index([submittedBy])
  @@index([layoutSlot])
  @@index([isActive])
  @@index([sortOrder])
  @@index([startDate, endDate])
}

enum AdvertisementStatus {
  PENDING       // Submitted by AdminKos, waiting approval
  APPROVED      // Approved by SuperAdmin, waiting placement
  PLACED        // Placed in layout and active
  REJECTED      // Rejected by SuperAdmin
  EXPIRED       // End date passed or manually deactivated
}

// Site Content for dynamic pages (Terms, Privacy, etc.)
model SiteContent {
  id          String   @id @default(cuid())
  type        String   @unique @db.VarChar(50) // "terms", "privacy", etc.
  title       String   @db.VarChar(255)
  content     String   @db.Text
  isPublished Boolean  @default(false)
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  updater     User?    @relation(fields: [updatedBy], references: [id])
  
  @@index([type])
  @@index([isPublished])
}
